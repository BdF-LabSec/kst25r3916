#include "st25r3916.h"

void ST25R3916_Init(ST25R *pInstance) // 4.1 # Power-on sequence
{
	ST25R3916_DirectCommand(pInstance, ST25R3916_CMD_SET_DEFAULT);
	pInstance->icIdentity = ST25R3916_Read_SingleRegister(pInstance, ST25R3916_REG_IC_IDENTITY);

	// To prevent the internal overheat protection to trigger below the junction temperature, the 3-byte frame FCh / 04h / 10h (register access / address / value) has to be sent after power-on and Set default command.
	ST25R3916_Write_SingleRegisterTEST(pInstance, ST25R3916_REG_T_unk_INCLUDING_OVERHEAT_PROTECTION, 0x10);

	// The IO configuration register 1 and IO configuration register 2 must be properly configured.
	ST25R3916_Write_Registers2_sep(pInstance, ST25R3916_REG_IO_CONF1,
			ST25R3916_REG_IO_CONF1_out_cl_disabled | ST25R3916_REG_IO_CONF1_lf_clk_off,
			ST25R3916_REG_IO_CONF2_sup3V_5V | ST25R3916_REG_IO_CONF2_aat_en | ST25R3916_REG_IO_CONF2_miso_pd2 | ST25R3916_REG_IO_CONF2_miso_pd1 | ST25R3916_REG_IO_CONF2_io_drv_lvl
	);

	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_OP_CONTROL, ST25R3916_REG_OP_CONTROL_en | ST25R3916_REG_OP_CONTROL_en_fd_efd_off);
	ST25R3916_WaitForIRQ(pInstance);
	ST25R3916_Mask_IRQ(pInstance, ST25R3916_IRQ_MASK_OSC, ST25R_IRQ_MASK_OP_ADD);

	// The internal voltage regulators have to be configured. It is recommended to use direct command Adjust regulators to improve the system PSRR.
	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_REGULATOR_CONTROL, ST25R3916_REG_REGULATOR_CONTROL_reg_s);
	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_REGULATOR_CONTROL, 0x00);
	ST25R3916_DirectCommand(pInstance, ST25R3916_CMD_ADJUST_REGULATORS);
	ST25R3916_WaitForIRQ(pInstance);
	ST25R3916_Mask_IRQ(pInstance, ST25R3916_IRQ_MASK_DCT, ST25R_IRQ_MASK_OP_ADD);

	// No AAT
}

void ST25R3916_WaitForIRQ(ST25R *pInstance)
{
	while(!pInstance->irqFlag);
	//pInstance->irqFlag = 0;
	ST25R3916_Read_IRQ(pInstance);
}

uint8_t ST25R3916_Generic_IRQ_toErr(uint32_t irq)
{
	uint8_t status = ST25R_STATUS_NO_ERROR;
	if(irq & ST25R3916_IRQ_MASK_CAC)
	{
		status |= ST25R_STATUS_COLLISION;
	}

	if(irq & ST25R3916_IRQ_MASK_NRE)
	{
		status |= ST25R_STATUS_NO_RESPONSE;
	}

	if(irq & ST25R3916_IRQ_MASK_CRC)
	{
		status |= ST25R_STATUS_CRC;
	}

	if(irq & (ST25R3916_IRQ_MASK_PAR | ST25R3916_IRQ_MASK_ERR2 | ST25R3916_IRQ_MASK_ERR1))
	{
		status |= ST25R_STATUS_PARITY_FRAMING;
	}

	return status;
}

uint8_t ST25R3916_FieldOn_AC(ST25R *pInstance)
{
	uint8_t ret;

	ST25R3916_DirectCommand(pInstance, ST25R3916_CMD_INITIAL_RF_COLLISION);
	ST25R3916_WaitForIRQ(pInstance);
	if(pInstance->irqStatus & ST25R3916_IRQ_MASK_CAC)
	{
		ret = ST25R_STATUS_COLLISION;
	}
	else if(pInstance->irqStatus & ST25R3916_IRQ_MASK_APON)
	{
		ST25R3916_WaitForIRQ(pInstance);
		if(pInstance->irqStatus & ST25R3916_IRQ_MASK_CAT)
		{
			ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_OP_CONTROL, ST25R3916_REG_OP_CONTROL_en | ST25R3916_REG_OP_CONTROL_en_fd_efd_off | ST25R3916_REG_OP_CONTROL_rx_en | ST25R3916_REG_OP_CONTROL_tx_en);
			ret = ST25R_STATUS_NO_ERROR;
		}
		else
		{
			ret = ST25R3916_Generic_IRQ_toErr(pInstance->irqStatus);
		}
	}
	else
	{
		ret = ST25T_STATUS_OTHER_IRQ;
	}

	return ret;
}

void ST25R3916_FieldOff(ST25R *pInstance)
{
	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_OP_CONTROL, ST25R3916_REG_OP_CONTROL_en | ST25R3916_REG_OP_CONTROL_en_fd_efd_off);
}

uint16_t ST25R3916_Fifo_Status(ST25R * pInstance, uint8_t *pStatus2)
{
	uint8_t buff[3] = {MK_READ(ST25R3916_REG_FIFO_STATUS1), };

	ST25R_SPI_COMM_ACQUIRE(pInstance);
	ST25R_SPI_COMM_TRANSMIT_RECEIVE(pInstance, buff, sizeof(buff));
	ST25R_SPI_COMM_RELEASE(pInstance);

	if(pStatus2)
	{
		*pStatus2 = buff[2] & ~ST25R3916_REG_FIFO_STATUS2_fifo_b_mask;
	}

	return ((buff[2] & ST25R3916_REG_FIFO_STATUS2_fifo_b_mask) << 2) | buff[1];;
}

void ST25R3916_Transmit(ST25R *pInstance, const uint8_t *pbData, const uint16_t cbData, const uint8_t bWithCRC)
{
	uint8_t buff[] = {MK_WRITE(ST25R3916_REG_NUM_TX_BYTES1), cbData >> (8 - 3), cbData << 3};
	ST25R_SPI_COMM_ACQUIRE(pInstance);
	ST25R_SPI_COMM_TRANSMIT(pInstance, buff, sizeof(buff));
	ST25R_SPI_COMM_RELEASE(pInstance);
	ST25R3916_Fifo_Load(pInstance, pbData, cbData);

	ST25R_SPI_DirectCommand_internal(pInstance, bWithCRC ? MK_CMD(ST25R3916_CMD_TRANSMIT_WITH_CRC) : MK_CMD(ST25R3916_CMD_TRANSMIT_WITHOUT_CRC));
}

void ST25R3916_Receive(ST25R *pInstance, const uint8_t bWithCRC)
{
	pInstance->cbData = ST25R3916_Fifo_Status(pInstance, NULL);
	if(pInstance->cbData && (pInstance->cbData <= sizeof(pInstance->pbData)))
	{
		ST25R3916_Fifo_Read(pInstance, pInstance->pbData, pInstance->cbData);
		if(bWithCRC)
		{
			pInstance->cbData -= 2;
		}
	}
}

uint8_t ST25R3916_Transmit_then_Receive(ST25R *pInstance, const uint8_t *pbData, const uint16_t cbData, const uint8_t bWithCRC)
{
	uint8_t ret;

	pInstance->cbData = 0;
	if(pbData && cbData)
	{
		ST25R3916_Transmit(pInstance, pbData, cbData, bWithCRC);
	}
	ST25R3916_WaitForIRQ(pInstance);
	ret = ST25R3916_Generic_IRQ_toErr(pInstance->irqStatus);
	if(ret == ST25R_STATUS_NO_ERROR)
	{
		if(pInstance->irqStatus & ST25R3916_IRQ_MASK_RXE)
		{
			ST25R3916_Receive(pInstance, bWithCRC);
		}
		else
		{
			ret = ST25T_STATUS_OTHER_IRQ;
		}
	}

	return ret;
}

void ST25R3916_14A_Initiator(ST25R *pInstance)
{
	ST25R3916_Mask_IRQ(pInstance, ST25R3916_IRQ_MASK_TXE | ST25R3916_IRQ_MASK_RXS, ST25R_IRQ_MASK_OP_ADD);
	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_MASK_RX_TIMER, 0x0e);
	//ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_NO_RESPONSE_TIMER2, 0x23); //
	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_TIMER_EMV_CONTROL, /*ST25R3916_REG_TIMER_EMV_CONTROL_gptc1 | ST25R3916_REG_TIMER_EMV_CONTROL_gptc0| */ST25R3916_REG_TIMER_EMV_CONTROL_nrt_step_64fc);
	ST25R3916_Write_Registers2_sep(pInstance, ST25R3916_REG_ANT_TUNE_A,
			0x82,
			0x82
	);
	ST25R3916_Write_Registers2_sep(pInstance, ST25R3916_REG_FIELD_THRESHOLD_ACTV,
			ST25R3916_REG_FIELD_THRESHOLD_ACTV_trg_105mV | ST25R3916_REG_FIELD_THRESHOLD_ACTV_rfe_105mV,
			ST25R3916_REG_FIELD_THRESHOLD_DEACTV_trg_75mV | ST25R3916_REG_FIELD_THRESHOLD_DEACTV_rfe_75mV
	);
	ST25R3916_Write_SingleRegisterB(pInstance, ST25R3916_REG_B_FIELD_ON_GT, 0x40);//0x06); // TODO bi techno

	ST25R3916_14A4_TxRx106(pInstance);
}

void ST25R3916_14A_Target(ST25R *pInstance)
{
	ST25R3916_Mask_IRQ(pInstance, ST25R3916_IRQ_MASK_TXE | ST25R3916_IRQ_MASK_RXS, ST25R_IRQ_MASK_OP_ADD);
	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_MASK_RX_TIMER, 0x02);
	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_TIMER_EMV_CONTROL, /*ST25R3916_REG_TIMER_EMV_CONTROL_gptc1 | ST25R3916_REG_TIMER_EMV_CONTROL_gptc0| */ST25R3916_REG_TIMER_EMV_CONTROL_nrt_step_64fc);
	ST25R3916_Write_Registers2_sep(pInstance, ST25R3916_REG_ANT_TUNE_A,
			0x00,
			0xff
	);
	ST25R3916_Write_Registers2_sep(pInstance, ST25R3916_REG_FIELD_THRESHOLD_ACTV,
			ST25R3916_REG_FIELD_THRESHOLD_ACTV_trg_105mV | ST25R3916_REG_FIELD_THRESHOLD_ACTV_rfe_105mV,
			ST25R3916_REG_FIELD_THRESHOLD_DEACTV_trg_75mV | ST25R3916_REG_FIELD_THRESHOLD_DEACTV_rfe_75mV
	);

	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_PASSIVE_TARGET, 5 << ST25R3916_REG_PASSIVE_TARGET_fdel_shift);
	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_PT_MOD, (5 << ST25R3916_REG_PT_MOD_ptm_res_shift) | (15 << ST25R3916_REG_PT_MOD_pt_res_shift));

	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_TX_DRIVER, ST25R3916_REG_TX_DRIVER_am_mod_12percent | 0);
}

//    /* Mode Name: POLL_A_ANTICOL, Mode ID: 0x0103 */
//        ST25R3916_REG_B_CORR_CONF1,0x40,0x00  /* User Defined ; Set collision detection level different from data */
void ST25R3916_14A4_TxRx106(ST25R *pInstance)
{
	ST25R3916_Write_Registers2_sep(pInstance, ST25R3916_REG_MODE,
			ST25R3916_REG_MODE_om_iso14443a | ST25R3916_REG_MODE_tr_am_ook,
			ST25R3916_REG_BIT_RATE_txrate_106 | ST25R3916_REG_BIT_RATE_rxrate_106
	);

	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_TX_DRIVER, ST25R3916_REG_TX_DRIVER_am_mod_12percent | 0);

	ST25R3916_Write_RegistersB4_sep(pInstance, ST25R3916_REG_B_OVERSHOOT_CONF1, \
			ST25R3916_REG_OVERSHOOT_CONF1_ov_tx_mode0,
			ST25R3916_REG_OVERSHOOT_CONF2_ov_pattern1 | ST25R3916_REG_OVERSHOOT_CONF2_ov_pattern0,
			ST25R3916_REG_UNDERSHOOT_CONF1_un_tx_mode0,
			ST25R3916_REG_UNDERSHOOT_CONF2_un_pattern1 | ST25R3916_REG_UNDERSHOOT_CONF2_un_pattern0
	);

	ST25R3916_Write_Registers4_sep(pInstance, ST25R3916_REG_RX_CONF1,
			ST25R3916_REG_RX_CONF1_hz_600_400khz,
			ST25R3916_REG_RX_CONF2_sqm_dyn | ST25R3916_REG_RX_CONF2_agc_en | ST25R3916_REG_RX_CONF2_agc_m | ST25R3916_REG_RX_CONF2_agc6_3,
			0,
			0
	);

	ST25R3916_Write_RegistersB2_sep(pInstance, ST25R3916_REG_B_CORR_CONF1, \
			ST25R3916_REG_CORR_CONF1_corr_s6 | ST25R3916_REG_CORR_CONF1_corr_s4 | ST25R3916_REG_CORR_CONF1_corr_s0,
			0
	);
}

void ST25R3916_14A4_TxRx212(ST25R *pInstance)
{
	ST25R3916_Write_Registers2_sep(pInstance, ST25R3916_REG_MODE,
			ST25R3916_REG_MODE_om_iso14443a | ST25R3916_REG_MODE_tr_am_am,
			ST25R3916_REG_BIT_RATE_txrate_212 | ST25R3916_REG_BIT_RATE_rxrate_212
	);

	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_TX_DRIVER, ST25R3916_REG_TX_DRIVER_am_mod_12percent | 0);
	ST25R3916_Write_SingleRegisterB(pInstance, ST25R3916_REG_B_AUX_MOD, ST25R3916_REG_AUX_MOD_dis_reg_am | ST25R3916_REG_AUX_MOD_lm_dri | ST25R3916_REG_AUX_MOD_res_am | 0);
	ST25R3916_Write_SingleRegisterB(pInstance, ST25R3916_REG_B_RES_AM_MOD, ST25R3916_REG_RES_AM_MOD_fa3_f | 0x7f);

	ST25R3916_Write_RegistersB4_sep(pInstance, ST25R3916_REG_B_OVERSHOOT_CONF1, \
			ST25R3916_REG_OVERSHOOT_CONF1_ov_tx_mode0,
			ST25R3916_REG_OVERSHOOT_CONF2_ov_pattern1 | ST25R3916_REG_OVERSHOOT_CONF2_ov_pattern0,
			ST25R3916_REG_UNDERSHOOT_CONF1_un_tx_mode0,
			ST25R3916_REG_UNDERSHOOT_CONF2_un_pattern1 | ST25R3916_REG_UNDERSHOOT_CONF2_un_pattern0
	);

	ST25R3916_Write_Registers4_sep(pInstance, ST25R3916_REG_RX_CONF1,
			ST25R3916_REG_RX_CONF1_hz_40_80khz,
			ST25R3916_REG_RX_CONF2_sqm_dyn | ST25R3916_REG_RX_CONF2_pulz_61 | ST25R3916_REG_RX_CONF2_agc_en | ST25R3916_REG_RX_CONF2_agc_m | ST25R3916_REG_RX_CONF2_agc6_3,
			0,
			0
	);

	ST25R3916_Write_RegistersB2_sep(pInstance, ST25R3916_REG_B_CORR_CONF1, \
			ST25R3916_REG_CORR_CONF1_corr_s4 | ST25R3916_REG_CORR_CONF1_corr_s2,
			0
	);
}

void ST25R3916_14A4_TxRx424(ST25R *pInstance)
{
	ST25R3916_Write_Registers2_sep(pInstance, ST25R3916_REG_MODE,
			ST25R3916_REG_MODE_om_iso14443a | ST25R3916_REG_MODE_tr_am_am,
			ST25R3916_REG_BIT_RATE_txrate_424 | ST25R3916_REG_BIT_RATE_rxrate_424
	);

	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_TX_DRIVER, ST25R3916_REG_TX_DRIVER_am_mod_12percent | 0);
	ST25R3916_Write_SingleRegisterB(pInstance, ST25R3916_REG_B_AUX_MOD, ST25R3916_REG_AUX_MOD_dis_reg_am | ST25R3916_REG_AUX_MOD_lm_dri | ST25R3916_REG_AUX_MOD_res_am | 0);
	ST25R3916_Write_SingleRegisterB(pInstance, ST25R3916_REG_B_RES_AM_MOD, ST25R3916_REG_RES_AM_MOD_fa3_f | 0x7f);

	ST25R3916_Write_RegistersB4_sep(pInstance, ST25R3916_REG_B_OVERSHOOT_CONF1, \
			ST25R3916_REG_OVERSHOOT_CONF1_ov_tx_mode0,
			ST25R3916_REG_OVERSHOOT_CONF2_ov_pattern1 | ST25R3916_REG_OVERSHOOT_CONF2_ov_pattern0,
			ST25R3916_REG_UNDERSHOOT_CONF1_un_tx_mode0,
			ST25R3916_REG_UNDERSHOOT_CONF2_un_pattern1 | ST25R3916_REG_UNDERSHOOT_CONF2_un_pattern0
	);

	ST25R3916_Write_Registers4_sep(pInstance, ST25R3916_REG_RX_CONF1,
			ST25R3916_REG_RX_CONF1_lp_2000khz | ST25R3916_REG_RX_CONF1_hz_40_80khz,
			ST25R3916_REG_RX_CONF2_sqm_dyn | ST25R3916_REG_RX_CONF2_pulz_61 | ST25R3916_REG_RX_CONF2_agc_en | ST25R3916_REG_RX_CONF2_agc_m | ST25R3916_REG_RX_CONF2_agc6_3,
			0,
			0
	);

	ST25R3916_Write_RegistersB2_sep(pInstance, ST25R3916_REG_B_CORR_CONF1, \
			ST25R3916_REG_CORR_CONF1_corr_s7 | ST25R3916_REG_CORR_CONF1_corr_s4 | ST25R3916_REG_CORR_CONF1_corr_s2,
			0
	);
}

void ST25R3916_14A4_TxRx848(ST25R *pInstance)
{
	ST25R3916_Write_Registers2_sep(pInstance, ST25R3916_REG_MODE,
			ST25R3916_REG_MODE_om_iso14443a | ST25R3916_REG_MODE_tr_am_am,
			ST25R3916_REG_BIT_RATE_txrate_848 | ST25R3916_REG_BIT_RATE_rxrate_848
	);

	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_TX_DRIVER, ST25R3916_REG_TX_DRIVER_am_mod_40percent | 0);
	ST25R3916_Write_SingleRegisterB(pInstance, ST25R3916_REG_B_AUX_MOD, ST25R3916_REG_AUX_MOD_lm_dri | 0);

	ST25R3916_Write_RegistersB4_sep(pInstance, ST25R3916_REG_B_OVERSHOOT_CONF1, \
			0,
			0,
			0,
			0
	);

	ST25R3916_Write_Registers4_sep(pInstance, ST25R3916_REG_RX_CONF1,
			ST25R3916_REG_RX_CONF1_lp_2000khz | ST25R3916_REG_RX_CONF1_hz_40_80khz,
			ST25R3916_REG_RX_CONF2_sqm_dyn | ST25R3916_REG_RX_CONF2_pulz_61 | ST25R3916_REG_RX_CONF2_agc_en | ST25R3916_REG_RX_CONF2_agc_m | ST25R3916_REG_RX_CONF2_agc6_3,
			0,
			0
	);

	ST25R3916_Write_RegistersB2_sep(pInstance, ST25R3916_REG_B_CORR_CONF1, \
			ST25R3916_REG_CORR_CONF1_corr_s6 | ST25R3916_REG_CORR_CONF1_corr_s2,
			0
	);
}

//void ST25R3916_14B_ST25TB_Initiator(ST25R *pInstance)
//{
//	ST25R3916_Mask_IRQ(pInstance, ST25R3916_IRQ_MASK_TXE | ST25R3916_IRQ_MASK_RXS, ST25R_IRQ_MASK_OP_ADD);
//
//	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_PASSIVE_TARGET, (5 << ST25R3916_REG_PASSIVE_TARGET_fdel_shift) | ST25R3916_REG_PASSIVE_TARGET_d_ac_ap2p |  ST25R3916_REG_PASSIVE_TARGET_d_212_424_1r | ST25R3916_REG_PASSIVE_TARGET_d_106_ac_a);
//
//	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_MODE, ST25R3916_REG_MODE_targ_init | ST25R3916_REG_MODE_om_iso14443b | ST25R3916_REG_MODE_tr_am_am);
//
//	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_RX_CONF1, ST25R3916_REG_RX_CONF1_h200 | ST25R3916_REG_RX_CONF1_lp_1200khz | ST25R3916_REG_RX_CONF1_ch_sel_AM);
//	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_RX_CONF2, ST25R3916_REG_RX_CONF2_agc6_3 | ST25R3916_REG_RX_CONF2_agc_m | ST25R3916_REG_RX_CONF2_agc_en | ST25R3916_REG_RX_CONF2_pulz_61 | ST25R3916_REG_RX_CONF2_sqm_dyn);
//	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_RX_CONF3, 0x00);
//	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_MASK_RX_TIMER, 0x0e);
//	//ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_NO_RESPONSE_TIMER2, 0x23); //
//	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_TIMER_EMV_CONTROL, /*ST25R3916_REG_TIMER_EMV_CONTROL_gptc1 | ST25R3916_REG_TIMER_EMV_CONTROL_gptc0| */ST25R3916_REG_TIMER_EMV_CONTROL_nrt_step_64fc);
//
//	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_ANT_TUNE_A, 0x82);
//	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_ANT_TUNE_B, 0x82);
//	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_TX_DRIVER, ST25R3916_REG_TX_DRIVER_am_mod_12percent | 0);
//	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_PT_MOD, (5 << ST25R3916_REG_PT_MOD_ptm_res_shift) | (15 << ST25R3916_REG_PT_MOD_pt_res_shift));
//	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_FIELD_THRESHOLD_ACTV, ST25R3916_REG_FIELD_THRESHOLD_ACTV_trg_105mV | ST25R3916_REG_FIELD_THRESHOLD_ACTV_rfe_105mV);
//	ST25R3916_Write_SingleRegister(pInstance, ST25R3916_REG_FIELD_THRESHOLD_DEACTV, 0x00);//ST25R3916_REG_FIELD_THRESHOLD_DEACTV_trg_75mV | ST25R3916_REG_FIELD_THRESHOLD_DEACTV_rfe_75mV);
//
//	ST25R3916_Write_SingleRegisterB(pInstance, ST25R3916_REG_B_RES_AM_MOD, ST25R3916_REG_RES_AM_MOD_fa3_f);
//	ST25R3916_Write_SingleRegisterB(pInstance, ST25R3916_REG_B_FIELD_ON_GT, 0x00);//0X40 0x06); // TODO bi techno
//	ST25R3916_Write_SingleRegisterB(pInstance, ST25R3916_REG_B_AUX_MOD, ST25R3916_REG_AUX_MOD_lm_dri | 0);
//	ST25R3916_Write_SingleRegisterB(pInstance, ST25R3916_REG_B_EMD_SUP_CONF, ST25R3916_REG_EMD_SUP_CONF_rx_start_emv_on | 4);
//	ST25R3916_Write_SingleRegisterB(pInstance, ST25R3916_REG_B_CORR_CONF1, ST25R3916_REG_CORR_CONF1_corr_s0 | ST25R3916_REG_CORR_CONF1_corr_s1 | ST25R3916_REG_CORR_CONF1_corr_s3 | ST25R3916_REG_CORR_CONF1_corr_s4);
//
////	ST25R3916_Write_SingleRegisterB(pInstance, ST25R3916_REG_B_OVERSHOOT_CONF1, ST25R3916_REG_OVERSHOOT_CONF1_ov_tx_mode0);
////	ST25R3916_Write_SingleRegisterB(pInstance, ST25R3916_REG_B_OVERSHOOT_CONF2, ST25R3916_REG_OVERSHOOT_CONF2_ov_pattern1 | ST25R3916_REG_OVERSHOOT_CONF2_ov_pattern0);
////	ST25R3916_Write_SingleRegisterB(pInstance, ST25R3916_REG_B_UNDERSHOOT_CONF1, ST25R3916_REG_UNDERSHOOT_CONF1_un_tx_mode0);
////	ST25R3916_Write_SingleRegisterB(pInstance, ST25R3916_REG_B_UNDERSHOOT_CONF2, ST25R3916_REG_UNDERSHOOT_CONF2_un_pattern1 | ST25R3916_REG_UNDERSHOOT_CONF2_un_pattern0);
//}

#define PRE_A	0
#define PRE_B	MK_CMD(ST25R3916_CMD_SPACE_B_ACCESS)
#define PRE_T	MK_CMD(ST25R3916_CMD_TEST_ACCESS)

typedef struct _ST_REGS {
	uint8_t pre;
	uint8_t reg;
	char *name;
	uint8_t def;
} ST_REGS, *PST_REGS;

const ST_REGS REGS[] = {
    {PRE_A, ST25R3916_REG_IO_CONF1, "IO_CONF1", 0x00},
	{PRE_A, ST25R3916_REG_IO_CONF2, "IO_CONF2", 0x00},
    {PRE_A, ST25R3916_REG_OP_CONTROL, "OP_CONTROL", 0x00},
	{PRE_A, ST25R3916_REG_MODE, "MODE", 0x08},
    {PRE_A, ST25R3916_REG_BIT_RATE, "BIT_RATE", 0x00},
	{PRE_A, ST25R3916_REG_ISO14443A_NFC, "ISO14443A_NFC", 0x00},
    {PRE_B, ST25R3916_REG_B_EMD_SUP_CONF, "EMD_SUP_CONF", 0x00},
	{PRE_A, ST25R3916_REG_ISO14443B_1, "ISO14443B_1", 0x00},
    {PRE_B, ST25R3916_REG_B_SUBC_START_TIME, "SUBC_START_TIME", 0x00},
	{PRE_A, ST25R3916_REG_ISO14443B_2, "ISO14443B_2", 0x00},
    {PRE_A, ST25R3916_REG_PASSIVE_TARGET, "PASSIVE_TARGET", 0x00},
	{PRE_A, ST25R3916_REG_STREAM_MODE, "STREAM_MODE", 0x00},
    {PRE_A, ST25R3916_REG_AUX, "AUX", 0x00},
	{PRE_A, ST25R3916_REG_RX_CONF1, "RX_CONF1", 0x08},
    {PRE_A, ST25R3916_REG_RX_CONF2, "RX_CONF2", 0x2d},
	{PRE_A, ST25R3916_REG_RX_CONF3, "RX_CONF3", 0xd8},
	{PRE_A, ST25R3916_REG_RX_CONF4, "RX_CONF4", 0x00},
    {PRE_B, ST25R3916_REG_B_P2P_RX_CONF, "P2P_RX_CONF", 0x0c},
	{PRE_B, ST25R3916_REG_B_CORR_CONF1, "CORR_CONF1", 0x93},
	{PRE_B, ST25R3916_REG_B_CORR_CONF2, "CORR_CONF2", 0x00},
    {PRE_A, ST25R3916_REG_MASK_RX_TIMER, "MASK_RX_TIMER", 0x0c},
	{PRE_A, ST25R3916_REG_NO_RESPONSE_TIMER1, "NO_RESPONSE_TIMER1", 0x00},
	{PRE_A, ST25R3916_REG_NO_RESPONSE_TIMER2, "NO_RESPONSE_TIMER2", 0x00},
    {PRE_A, ST25R3916_REG_TIMER_EMV_CONTROL, "TIMER_EMV_CONTROL", 0x00},
	{PRE_A, ST25R3916_REG_GPT1, "GPT1", 0x00},
	{PRE_A, ST25R3916_REG_GPT2, "GPT2", 0x00},
    {PRE_A, ST25R3916_REG_PPON2, "PPON2", 0x80},
	{PRE_B, ST25R3916_REG_B_SQUELCH_TIMER, "SQUELCH_TIMER", 0x00},
	{PRE_B, ST25R3916_REG_B_FIELD_ON_GT, "FIELD_ON_GT", 0x33},
    {PRE_A, ST25R3916_REG_IRQ_MASK_MAIN, "IRQ_MASK_MAIN", 0x00},
	{PRE_A, ST25R3916_REG_IRQ_MASK_TIMER_NFC, "IRQ_MASK_TIMER_NFC", 0x00},
	{PRE_A, ST25R3916_REG_IRQ_MASK_ERROR_WUP, "IRQ_MASK_ERROR_WUP", 0x00},
    {PRE_A, ST25R3916_REG_IRQ_MASK_TARGET, "IRQ_MASK_TARGET", 0x00},
	//{ST25R3916_REG_IRQ_MAIN, "IRQ_MAIN"},
	//{ST25R3916_REG_IRQ_TIMER_NFC, "IRQ_TIMER_NFC"},
    //{ST25R3916_REG_IRQ_ERROR_WUP, "IRQ_ERROR_WUP"},
	//{ST25R3916_REG_IRQ_TARGET, "IRQ_TARGET"},
	//{ST25R3916_REG_FIFO_STATUS1, "FIFO_STATUS1"},
	//{ST25R3916_REG_FIFO_STATUS2, "FIFO_STATUS2"},
    //{ST25R3916_REG_COLLISION_STATUS, "COLLISION_STATUS"},
	//{ST25R3916_REG_PASSIVE_TARGET_STATUS, "PASSIVE_TARGET_STATUS"},
	{PRE_A, ST25R3916_REG_NUM_TX_BYTES1, "NUM_TX_BYTES1", 0x00},
    {PRE_A, ST25R3916_REG_NUM_TX_BYTES2, "NUM_TX_BYTES2", 0x00},
	{PRE_A, ST25R3916_REG_NFCIP1_BIT_RATE, "NFCIP1_BIT_RATE", 0x00},
	{PRE_A, ST25R3916_REG_AD_RESULT, "AD_RESULT", 0x00},
    {PRE_A, ST25R3916_REG_ANT_TUNE_A, "ANT_TUNE_A", 0x80},
	{PRE_A, ST25R3916_REG_ANT_TUNE_B, "ANT_TUNE_B", 0x80},
	{PRE_A, ST25R3916_REG_TX_DRIVER, "TX_DRIVER", 0x70},
    {PRE_A, ST25R3916_REG_PT_MOD, "PT_MOD", 0x60},
	{PRE_B, ST25R3916_REG_B_AUX_MOD, "AUX_MOD", 0x10},
	{PRE_B, ST25R3916_REG_B_TX_DRIVER_TIMING, "TX_DRIVER_TIMING", 0x7c},
    {PRE_B, ST25R3916_REG_B_RES_AM_MOD, "RES_AM_MOD", 0x00},
	{PRE_B, ST25R3916_REG_B_TX_DRIVER_STATUS, "TX_DRIVER_STATUS", 0x04},
	{PRE_A, ST25R3916_REG_FIELD_THRESHOLD_ACTV, "FIELD_THRESHOLD_ACTV", 0x33},
	{PRE_A, ST25R3916_REG_FIELD_THRESHOLD_DEACTV, "FIELD_THRESHOLD_DEACTV", 0x22},
    {PRE_A, ST25R3916_REG_REGULATOR_CONTROL, "REGULATOR_CONTROL", 0x00},
	{PRE_B, ST25R3916_REG_B_REGULATOR_RESULT, "REGULATOR_RESULT", 0xf0},
	{PRE_A, ST25R3916_REG_RSSI_RESULT, "RSSI_RESULT", 0x00},
    {PRE_A, ST25R3916_REG_GAIN_RED_STATE, "GAIN_RED_STATE", 0x00},
	{PRE_A, ST25R3916_REG_CAP_SENSOR_CONTROL, "CAP_SENSOR_CONTROL", 0x00},
	{PRE_A, ST25R3916_REG_CAP_SENSOR_RESULT, "CAP_SENSOR_RESULT", 0x00},
    {PRE_A, ST25R3916_REG_AUX_DISPLAY, "AUX_DISPLAY", 0x00},
	{PRE_B, ST25R3916_REG_B_OVERSHOOT_CONF1, "OVERSHOOT_CONF1", 0x00},
	{PRE_B, ST25R3916_REG_B_OVERSHOOT_CONF2, "OVERSHOOT_CONF2", 0x00},
    {PRE_B, ST25R3916_REG_B_UNDERSHOOT_CONF1, "UNDERSHOOT_CONF1", 0x00},
	{PRE_B, ST25R3916_REG_B_UNDERSHOOT_CONF2, "UNDERSHOOT_CONF2", 0x00},
	{PRE_A, ST25R3916_REG_WUP_TIMER_CONTROL, "WUP_TIMER_CONTROL", 0x00},
    {PRE_A, ST25R3916_REG_AMPLITUDE_MEASURE_CONF, "AMPLITUDE_MEASURE_CONF", 0x00},
	{PRE_A, ST25R3916_REG_AMPLITUDE_MEASURE_REF, "AMPLITUDE_MEASURE_REF", 0x00},
	{PRE_A, ST25R3916_REG_AMPLITUDE_MEASURE_AA_RESULT, "AMPLITUDE_MEASURE_AA_RESULT", 0x00},
	{PRE_A, ST25R3916_REG_AMPLITUDE_MEASURE_RESULT, "AMPLITUDE_MEASURE_RESULT", 0x00},
    {PRE_A, ST25R3916_REG_PHASE_MEASURE_CONF, "PHASE_MEASURE_CONF", 0x00},
	{PRE_A, ST25R3916_REG_PHASE_MEASURE_REF, "PHASE_MEASURE_REF", 0x00},
	{PRE_A, ST25R3916_REG_PHASE_MEASURE_AA_RESULT, "PHASE_MEASURE_AA_RESULT", 0x00},
    {PRE_A, ST25R3916_REG_PHASE_MEASURE_RESULT, "PHASE_MEASURE_RESULT", 0x00},
	{PRE_A, ST25R3916_REG_CAPACITANCE_MEASURE_CONF, "CAPACITANCE_MEASURE_CONF", 0x00},
	{PRE_A, ST25R3916_REG_CAPACITANCE_MEASURE_REF, "CAPACITANCE_MEASURE_REF", 0x00},
    {PRE_A, ST25R3916_REG_CAPACITANCE_MEASURE_AA_RESULT, "CAPACITANCE_MEASURE_AA_RESULT", 0x00},
	{PRE_A, ST25R3916_REG_CAPACITANCE_MEASURE_RESULT, "CAPACITANCE_MEASURE_RESULT", 0x00},
	{PRE_A, ST25R3916_REG_IC_IDENTITY, "IC_IDENTITY", 0x2a},
	{PRE_T, ST25R3916_REG_T_ANALOG_TEST_AND_OBSERVATION_1, "ANALOG_TEST_AND_OBSERVATION_1", 0x40},
	{PRE_T, ST25R3916_REG_T_unk_INCLUDING_OVERHEAT_PROTECTION, "unk_INCLUDING_OVERHEAT_PROTECTION", 0x00},
};
#include <stdio.h>
void ST25R_DumpRegs(ST25R * pInstance, uint8_t onlyDefaultDiff)
{
	uint8_t val;
	uint16_t i;
	for (i = 0; i < sizeof(REGS) / sizeof(REGS[0]); i++)
	{
		val = ST25R_SPI_Read_SingleRegister_internal(pInstance, REGS[i].pre, MK_READ(REGS[i].reg));

		if(!onlyDefaultDiff || (val != REGS[i].def))
		{
			printf("[%c] 0x%02hx - %s: 0x%02hx\r\n", (REGS[i].pre == PRE_B) ? 'B' : ((REGS[i].pre == PRE_T) ? 'T' : 'A'), REGS[i].reg,  REGS[i].name, val);
		}
	}
}
